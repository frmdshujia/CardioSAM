# @package _global_
# Inherit np_en_v1 (3 categories + noun_phrase prompts) and enable text-adapter finetuning.
defaults:
  - acdc_image_adapter_280_bz8_ts350_np_en_v1.yaml
  - _self_

paths:
  experiment_log_dir: /data/home/shujia/CardioSAM/outputs/acdc_adapter_280_bz8_ts350_np_en_v1_text_adapter

trainer:
  model:
    text_adapter_cfg:
      enable_adapter: True
      adapter_dim: 32
      adapter_dropout: 0.1
      adapter_scale: 1.0
  optim:
    # Base config freezes the whole language backbone; re-enable adapter params.
    param_group_modifiers:
      - _target_: sam3.train.optim.optimizer.freeze_param_modifier
        _partial_: True
        apply_to:
          - 'backbone.vision_backbone.trunk.blocks.*'
          - 'backbone.vision_backbone.trunk.patch_embed.*'
          - 'backbone.vision_backbone.trunk.pos_embed'
          - 'backbone.vision_backbone.trunk.class_embedding'
          - 'backbone.vision_backbone.trunk.ln_pre.*'
          - 'backbone.vision_backbone.trunk.ln_post.*'
          - 'backbone.language_backbone.*'
      - _target_: sam3.train.optim.optimizer.unfreeze_param_modifier
        _partial_: True
        apply_to:
          - 'backbone.language_backbone.*adapter*'
      - _target_: sam3.train.optim.optimizer.layer_decay_param_modifier
        _partial_: True
        layer_decay_value: ${scratch.lrd_vision_backbone}
        apply_to: 'backbone.vision_backbone.trunk'
        overrides:
          - pattern: '*pos_embed*'
            value: 1.0
  logging:
    wandb_writer:
      name: acdc_adapter_280_bz8_ts350_np_en_v1_text_adapter
      tags: [acdc, sam3, adapter, text_adapter, res280, ts350, np_en_v1]


# TRITON_CACHE_DIR=/data/home/shujia/triton_cache CUDA_VISIBLE_DEVICES=0 \
# python sam3/train/train.py -c configs/acdc/acdc_image_adapter_280_bz8_ts350_np_en_v1_text_adapter.yaml --use-cluster 0 --num-gpus 1 \
# 2>&1 | tee /data/home/shujia/CardioSAM/outputs/acdc_adapter_280_bz8_ts350_np_en_v1_text_adapter/train.log

